<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KumejimaLab AR</title>

  <!-- model-viewer 本体（CDN） -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    body { margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    model-viewer { width: 100%; height: 70vh; background: #f6f6f6; border-radius: 12px; }
    .controls { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:8px; border:1px solid #ddd; cursor:pointer; }
    .note { color:#444; font-size: 14px; line-height:1.6; margin-top:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>KumejimaLab - AR viewer</h1>

    <!--
      ポイント：
      - src: GLB（ページ内＆Android向け）
      - ios-src: iOS AR用のUSDZ（ユーザー提供: KumejimaLab_All.usdz）
      - ar: ARボタン有効化
      - ar-modes: WebXR/Scene Viewer/Quick Look を指定
      - autoplay: 単一アニメの自動再生
      - animation-loop: ループ
    -->
    <model-viewer id="lab"
      src="KumejimaLab_All.glb"
      ios-src="KumejimaLab_All.usdz"
      alt="KumejimaLab avatars"
      ar
      ar-modes="webxr scene-viewer quick-look"
      camera-controls
      autoplay
      animation-loop
      shadow-intensity="1"
      exposure="1.0"
      environment-image="neutral"
      poster=""
      touch-action="pan-y">
    </model-viewer>

    <div class="controls">
      <button id="playAll">▶︎ Play all（順番に再生）</button>
      <button id="pause">⏸ Pause</button>
      <button id="resume">⏵ Resume</button>
      <button id="reset">⟲ Reset</button>
    </div>

    <p class="note">
      • AndroidのARでは <code>KumejimaLab_All.glb</code> のアニメが再生されます。<br/>
      • iPhoneのAR（Quick Look）では <code>KumejimaLab_All.usdz</code> のアニメが再生されます。<br/>
      • ページ内の表示はGLBのままでOKです。
    </p>
  </div>

  <script>
    const mv = document.querySelector('#lab');
    const btnPlayAll = document.querySelector('#playAll');
    const btnPause = document.querySelector('#pause');
    const btnResume = document.querySelector('#resume');
    const btnReset = document.querySelector('#reset');

    let anims = [];
    let idx = 0;
    let playingAll = false;

    function playNext() {
      if (!playingAll || anims.length === 0) return;
      const name = anims[idx % anims.length];
      mv.animationName = name;
      mv.play({ repetitions: 1 });
    }

    mv.addEventListener('load', () => {
      anims = (mv.availableAnimations || []).filter(n => n !== 'TPose');
    });

    mv.addEventListener('finished', () => {
      if (!playingAll) return;
      idx++;
      playNext();
    });

    btnPlayAll.addEventListener('click', () => {
      if (!anims.length) { mv.play(); return; }
      playingAll = true;
      idx = 0;
      playNext();
    });

    btnPause.addEventListener('click', () => { mv.pause(); });
    btnResume.addEventListener('click', () => { mv.play(); });
    btnReset.addEventListener('click', () => {
      playingAll = false;
      mv.currentTime = 0;
      mv.pause();
    });
  </script>
</body>
</html>
